# Serial peripheral interface串行外设接口(SPI)  
## 简介  
SPI接口可以使用SPI协议与外部设备进行通信。SPI模式由软件选择。在器件复位后默认选择SPI Motorola模式。  
串行外设接口（SPI）协议支持与外部器件的半双工、全双工和单工同步串行通信。接口可以配置为主模式，向外部从器件提供通信时钟（SCK）。该接口也可在多主机配置下工作。  
## SPI主要特性  
- 主/从操作  
- 三线全双工同步传输  
- 两线半双工同步传输（使用双向数据线）  
- 两线单工同步传输（使用单向数据线）  
- 4到16位数据大小，可选择  
- 多主模式能力  
- 8个主模式波特率预分频器，高达f<sub>PCLK</sub>/2  
- 从模式频率高达f<sub>PCLK</sub>/2  
- 主或从模式下，NSS可由硬件或软件管理：主/从操作的动态变化  
- 可编程的时钟极性和相位  
- 可编程的数据移位顺序：MSB在前或LSB在前  
- 专门的发送和接收标志，可以触发中断  
- SPI总线忙状态标志  
- 支持SPI Motorola模式  
- 确保可靠通信的硬件CRC功能：  
　- 在Tx模式，最后一个字节发送CRC值  
　- 接收方，对最后一个接收的字节，自动进行CRC错误校验  
- 主模式故障、溢出标志，可以触发中断  
- CRC错误标志  
- 2个支持DMA的内置32位Rx和Tx FIFO  
- 支持SPI TI模式  
## SPI实现  
![](https://i.imgur.com/npTsjwl.png)  
## SPI功能描述  
### 一般说明  
SPI支持MCU和外设之间的同步串行通信。应用软件可以通过查询状态标志或专门的SPI中断，来管理通信。下图显示了SPI主要的部件和它们之间的相互作用。  
![](https://i.imgur.com/xB99se9.png)  
4个引脚用于于外设进行SPI通信。  
- MISO：主输入/从输出数据。通常，该引脚用于在从模式下发送数据，而在主模式下接收数据。  
- MOSI：主输出/从输入数据。通常，该引脚用于在主模式下发送数据，而在从模式下接收数据。  
- SCK：SPI主器件的串行时钟输出，SPI从器件的串行时钟输入。  
- NSS：从器件选择引脚。根据SPI和NSS的设置，该引脚用于：  
　- 选中一个从器件来通信  
　- 使数据帧同步  
　- 检测多个主器件间的冲突  
SPI支持一个主器件和多个从器件之间通信。总线至少要2条线：一个时钟信号线，一个同步传输数据线。其它信号根据SPI节点之间的数据交换和它们的从器件选择信号的管理来添加。  
### 一主一从之间通信  
SPI支持MCU根据不同的目标器件和应用需求，使用不同的配置进行通信。这些配置使用2或3条线（软件NSS管理），也可以使用3或4条线（硬件NSS管理）。通信总是由主器件发起。  
#### 全双工通信  
默认情况下，SPI配置为全双工通信。主器件和从器件的移位寄存器通过各自MOSI引脚之间和MISO引脚之间的2条单向线连接在一起。在SPI通信过程中，数据在主器件提供的时钟SCK的边沿同步移位。主器件通过MOSI线向从器件发送数据，通过MISO线接收从器件发来的数据。当数据帧传输完成（所有位都已移出），主器件和从器件之间完成信息交换。  
![](https://i.imgur.com/j2imCTC.png)  
1. NSS引脚可以用于在主器件和从器件之间提供硬件控制流。另外，也可以不使用NSS引脚，此时，需要在主器件和从器件内部处理控制流。  
#### 半双工通信  
通过将SPIx_CR1寄存器中的BIDIMODE位置1，可以将SPI配置为半双工通信。通过一条交叉线将主器件和从器件的移位寄存器连接起来。在通信过程中，数据在SCK时钟的边沿同步移位，传输方向由各自的SPIx_CR1寄存器中的BDIOE位设置。此模式下，主器件的MISO引脚和从器件的MOSI引脚没有使用，可以作为GPIO使用。  
![](https://i.imgur.com/u5XjHTs.png)  
1. NSS引脚可以用于在主器件和从器件之间提供硬件控制流。另外，也可以不使用NSS引脚，此时，需要在主器件和从器件内部处理控制流。  
2. 主器件的MISO引脚和从器件的MOSI引脚，可以用作GPIO。  
3. 当2个节点之间的通信方向不同步改变时，会发生严重情况。新的发送器访问数据线，而此时旧的发送器还在线上保持相反的值（该值取决于SPI配置和通信数据）。当2个节点在同一线路上输出相反的电平，会造成冲突，直到一个节点改变自己的方向（设置为反方向）。建议在主器件的MOSI和从器件的MISO引脚之间串接一个电阻，以保护输出和限制它们之间的电流。  
#### 单工通信  
通过SPIx_CR2寄存器中的RXONLY位选择只发送或只接收，将SPI配置为单工通信。通过一条线将主器件和从器件的移位寄存器连接起来。通信不使用的MISO和MOSI引脚，可以用作GPIO。  
- 只发送（RXONLY=0）：配置设置和全双工一样。忽略未用引脚上的输入，该引脚可以配置为GPIO使用。  
- 只接收（RXONLY=1）：禁止SPI输出。从模式下，MISO输出被禁止，该引脚可以用作GPIO。当从器件选择信号有效时，从器件从MOSI引脚接收数据。接收数据事件根据数据缓冲区的配置产生。在主模式下，MOSI输出禁止，该引脚可以配置为GPIO。时钟信号只要SPI使能，就会一直产生。要停止时钟输出，只有将RXONLY位或SPE位清零，并等待MISO引脚上的输入完成，根据数据缓冲区的配置，将其填满。  
![](https://i.imgur.com/cIzcG1Q.png)  
1. NSS引脚可以用于在主器件和从器件之间提供硬件控制流。另外，也可以不使用NSS引脚，此时，需要在主器件和从器件内部处理控制流。  
2. 输入移位寄存器中偶尔捕获的数据，在只发送模式下，必须被丢弃（例如，OVF标志）。  
3. 主器件和从器件的MISO引脚可以当作GPIO使用。  
注：单工通信可以用方向固定的半双工通信替代（BDIO位保持不变）。  
### 标准的多从器件通信  
在有2个或更多独立的从器件时，主器件使用多个GPIO引脚作为每个从器件的选择引脚。主器件将和从器件NSS输入相连的GPIO拉低，来选择该从器件。此时，一个标准的主器件和从器件的通信就建立起来了。  
![](https://i.imgur.com/r9my9rj.png)  
1. 主器件的NSS引脚不使用。它需要在内部管理（SSM=1，SSI=1）以避免MODF错误。  
2. 因为所有从器件的MISO连接在一起，它们的MISO引脚的GPIO配置都要配置为复用功能开漏。  
### 多主器件通信  
除非SPI总线不支持多主器件，否则，用户可以使用内部功能来检测2个节点同时试图掌控总线造成的冲突。为此，NSS引脚要配置为输入。  
这种模式下，连接的SPI节点不能超过2个，因为某一时刻只能有一个节点在一个公共数据线上输出数据。  
当2个节点都未激活时，默认处于从模式。一旦一个节点想要控制总线，它就切换到主模式，并通过GPIO引脚向另一个节点的从模式选择输入引脚，输出有效电平。通信完成后，从器件选择信号被释放，处于主模式的节点恢复到从模式，等待下一次通信。  
如果2个节点同时要求控制总线，就会产生冲突（参见模式故障MODF事件）。然后，用户可以应用一些简单仲裁程序（例如，通过在两个节点上应用预定义的不同超时来推迟下一次尝试）。  
![](https://i.imgur.com/Z0Bf61S.png)  
1. 2个节点的NSS引脚都要配置为输入。NSS上的有效电平会使能MISO线的输出控制，当被动节点配置为从器件时。  
### 从器件选择（NSS）引脚管理  
