#Real-time clock(RTC)  
##简介  
实时时钟RTC提供用于管理所有低功耗模式的自动唤醒单元。  
RTC是一个独立的BCD定时/计数器。RTC提供一个具有可编程报警功能的日历时钟。  
RTC还包含一个具有中断功能的周期性的可编程的唤醒标志。  
2个32位寄存器包含以BCD码格式表示的秒、分钟、小时（12或24小时制）、星期、日、月、年。亚秒值也是按二进制格式提供。  
每月的天数是28天/29天（闰年）/30天/31天会自动补偿。还可以执行夏令时时间补偿。  
另外的32位寄存器包含可编程的用于报警的亚秒、秒、分、时、星期和日期。  
一个数字校准功能可以用来对晶振精度的偏差进行补偿。  
RTC域复位后，所有的RTC寄存器被保护，以防非正常的写访问。  
不管器件处于何种状态（运行，低功耗或复位状态），只要供电电压在工作电压范围内，RTC就不会停止。  
##RTC主要特性  
RTC模块的主要特性如下：  
- 包含亚秒、秒、分钟、小时（12或24小时制）、星期、日期、月份、年份的日历。  
- 由软件编程的夏令时补偿。  
- 带中断的可编程报警功能。任何日历中的字段组合都可以用来触发报警。  
- 自动唤醒单元产生一个周期性的标志以触发自动唤醒中断。  
- 参考时钟检测：可以使用更精确的第二时钟源（50或60Hz）来提高日历的精确度。  
- 利用亚秒级移位特性与外部时钟精确同步。  
- 数字补偿电路（周期性的计数器校正）：精度为0.95ppm，在几秒的补偿窗口中获得。  
- 用于事件保存的时间戳功能。  
- 具有可配置滤波器和内部上拉的入侵检测事件。  
- 可屏蔽中断/事件：  
　- 闹钟A  
　- 唤醒中断  
　- 时间戳  
　- 入侵检测  
##RTC实时时钟的实现  
![](https://i.imgur.com/Iz9T3aH.png)  
##RTC功能描述  
###RTC框图  
![](https://i.imgur.com/IBg39k9.png)  
![](https://i.imgur.com/CJ0Nt0m.png)  
![](https://i.imgur.com/eDipvsa.png)  
![](https://i.imgur.com/vbe9r59.png)  
RTC包含：  
- 一个闹钟  
- 来自IO口的2个入侵事件  
　- 入侵检测擦除备份寄存器  
- 来自IO口的一个时间戳事件  
- 入侵事件检测可以产生一个时间戳事件  
- 复用功能输出：RTC_OUT可以选择下面2个输出其中之一：  
　- RTC_CALIB：512Hz或1Hz时钟输出（用32.768kHz的外部LSE时）。可以通过设置RTC_CR寄存器中的COE=1，使能这个输出。  
　- RTC_ALARM：闹钟A。可以通过配置RTC_CR寄存器中OSEL[1:0]位选择这个输出。  
- 复位功能输入：  
　- RTC_TS：时间戳事件  
　- RTC_TAMP1：入侵事件检测1  
　- RTC_TAMP2：入侵事件检测2  
　- RTC_REFIN：50或60Hz参考时钟输入  
###RTC控制GPIOs  
RTC_OUT,RTC_TS和RTC_TAMP1被映射到同一个引脚PC13上。  
RTC_ALARM输出的选择通过RTC_TAFCR寄存器如下操作：PC13VALUE位用于选择RTC_ALARM输出配置成推挽或开漏模式。  
当PC13不用作RTC复用功能时，可以通过设置RTC_TAFCR中的PC13MODE=1，强制其为推挽输出模式，而PC13VALUE位决定其输出值。这种情况下，PC13的推挽输出状态和输出值在待机模式下是可以保持的。  
PC13的输出机制遵循表63所示的优先级顺序。  
当PC14和PC15不用作LSE振荡器时，可以通过设置RTC_TAFCR中的PC14MODE=1和PC15MODE=1，强制其为推挽输出模式；其输出值由PC14VALUE和PC15VALUE决定。这种情况下，PC14和PC15的推挽输出状态和输出值在待机模式下是可以保持的。  
PC14和PC15的输出机制遵循表64和表65所示的优先级顺序。  
![](https://i.imgur.com/exByiwo.png)  
![](https://i.imgur.com/ewFCoPq.png)  
###时钟和预分频器  
RTC时钟源RTCCLK由时钟控制器在LSE、LSI和HSE时钟之间选择。  
一个可编程的预分频器产生1Hz的时钟，用于更新日历。为了最大程度的降低功耗，预分频器分割成2个可编程预分频器（参见图192：RTC框图）：  
- 通过RTC_PRER寄存器的PREDIV_A位配置的7位异步预分频器。  
- 通过RTC_PRER寄存器的PREDIV_S位配置的15位同步预分频器。  
注：当2个预分频器都使用时，建议将异步预分频器配置为较高的值，以减少功耗。  
使用32.768KHz的LSE时钟时，异步分频器的分频系数设为128，同步分频器的分频系数设为256，从而得到1Hz（ck_spre）的内部时钟频率。